---
title: "Simulation Explaining DIF"
author: "Thijs Carriere"
date: "16-1-2022"
output: html_document
---

## 0. Libraries and goals

```{r message=FALSE, warning=FALSE}
# Needed packages
library(lavaan)
library(tidyverse)
```

The goal of this simulation is to find out if detected DIF can be explained in a 2 group DIF. Response times are used to explain the DIF. In an earlier document, DIF is detected by MIMIC models already. 

## 1. Data

A earlier created data set is used. The data has 2 groups with a different ability (group 1 mean = -.5, group 2 mean = .5). Based on these thetas 7 items are answered (0 / 1). For item 5, a parameters are different across groups. For item 6, b parameters are different over groups. For item 7, both a and b parameters are different over groups. Lastly, response times are simulated for all groups, differing in the items that have DIF. 

```{r}
dat.use <- read.csv("data_simulation.csv", sep = ",", header = F)
names(dat.use) <- c("ID", "theta","group", "dum", "Y1", "Y2", "Y3", "Y4", "Y5", "Y6", "Y7", "T1", "T2", "T3", "T4", "T5", "T6")
```

## 2. Explaining DIF

### 2.1 Item 5

Before explaining DIF, it is detected again. After that, the response time as added to see if it can explain the DIF. 2/3 methods are used to compare what statistics best can be used to check whether DIF is explained.

The models run in order are:
1. A baseline model to compare the DIF model with. There is just the latent trait and a grouping variable where this trait is regressed on.

2. A DIF model: In this model the item is regressed on the group. When the parameter for this regression is significant, DIF is present.

3. A model where response times are added for this item. These process data are regressed on the grouping variable, and the DIF item is regressed on the process data. It is inspected whether the regression from test item to process data is significant.

4. The same model as model 3, but now with the DIF line present again to see if this line changed.

5. The same model as model 3, but now with process data that does not explain anything to see what the model gives as output then.

```{r}
# baseline model
baseline5 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y5 
lat ~ group
'

dif5 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y5 
lat ~ group
Y5 ~ group
'

# Running the models
baseline5_mod <- sem(model = baseline5, data = dat.use, ordered = colnames(dat.use[,3:11]))

dif5_mod <- sem(model = dif5, data = dat.use, ordered = colnames(dat.use[,3:11]))
summary(dif5_mod)

anova(baseline5_mod, dif5_mod)
```

```{r}
expl5 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y5 
lat ~ group
T5 ~ group
Y5 ~ T5
'

expl5_mod <- sem(model = expl5, data = dat.use, ordered = colnames(dat.use[,3:11]))
summary(expl5_mod, fit.measures=T)

expl5_1 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y5 
lat ~ group
T5 ~ group
Y5 ~ T5 + group
'

expl5_1_mod <- sem(model = expl5_1, data = dat.use, ordered = colnames(dat.use[,3:11]))

summary(expl5_1_mod)
```

Now add another response time, where the groups do not differ.

```{r}
dat.use$T5_2 <- rnorm(600, 50, 10)

expl5_2 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y5 
lat ~ group
T5_2 ~ group
Y5 ~ T5_2
'

expl5_2_mod <- sem(model = expl5_2, data = dat.use, ordered = colnames(dat.use[,3:11]))
summary(expl5_2_mod, fit.measures=T)
```

### 2.2 Item 6

For item 6, the same steps as for item 5 are executed, with exception of model 5.5.

```{r}
# detection of DIF
baseline6 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y6 
lat ~ group
'

dif6 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y6 
lat ~ group
Y6 ~ group
'

# Running the models
baseline6_mod <- sem(model = baseline6, data = dat.use, ordered = colnames(dat.use[,3:11]))

dif6_mod <- sem(model = dif6, data = dat.use, ordered = colnames(dat.use[,3:11]))
summary(dif6_mod)

anova(baseline6_mod, dif6_mod)
```

```{r}
# Now explaining the DIF in 6
expl6 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y6 
lat ~ group
T6 ~ group
Y6 ~ T6
'

expl6_mod <- sem(model = expl6, data = dat.use, ordered = colnames(dat.use[,3:11]))
summary(expl6_mod, fit.measures=T)

expl6_1 <- '
lat =~ Y1 + Y2 + Y3 + Y4 + Y6 
lat ~ group
T6 ~ group
Y6 ~ T6 + group
'

expl6_1_mod <- sem(model = expl6_1, data = dat.use, ordered = colnames(dat.use[,3:11]))

summary(expl6_1_mod)
```



## 3. Conclusions

1. For item 5 the response times do explain some of the DIF, but it stays significant after adding the DIF. A better way to check if DIF is explained might be by comparing the model that includes the covariate, but does not regress the item on it with the model where it is regressed (and still includes the 'DIF-line').

2. The same things are found for item 6 as for item 5.

3. The test statistic of the DIF-line becomes less when including the process data, but stays significant. The regression from process data to the DIF item becomes insignificant when the DIF line is added, but is significant before. 

4. The explanation seems to work for both uniform and non-uniform DIF items. 
